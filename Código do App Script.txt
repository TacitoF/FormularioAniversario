/**
 * Recebe os dados do formul√°rio e gerencia grava√ß√£o/remo√ß√£o com trava de seguran√ßa.
 */
function doPost(e) {
  var lock = LockService.getPublicLock();
  try {
    lock.waitLock(30000); 
  } catch (f) {
    return ContentService.createTextOutput("Erro: Servidor ocupado.").setMimeType(ContentService.MimeType.TEXT);
  }

  try {
    var requestData = JSON.parse(e.postData.contents);
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

    if (requestData.action === 'delete') {
      var rows = sheet.getDataRange().getValues();
      var idAlvo = String(requestData.id).trim(); 
      for (var i = rows.length - 1; i >= 1; i--) {
        if (String(rows[i][3]).trim() === idAlvo) {
          sheet.deleteRow(i + 1);
          return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.TEXT);
        }
      }
    }

    sheet.appendRow([
      requestData.nome, 
      requestData.presenca, 
      requestData.acompanhantes, 
      "'" + requestData.id,
      requestData.email,
      requestData.lembrete
    ]);

    SpreadsheetApp.flush();
    return ContentService.createTextOutput("Sucesso").setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    Logger.log("Erro no doPost: " + err);
    return ContentService.createTextOutput("Erro").setMimeType(ContentService.MimeType.TEXT);
  } finally {
    lock.releaseLock();
  }
}

/**
 * RELAT√ìRIO CONSOLIDADO DI√ÅRIO (Gatilho: Di√°rio, 10:00 √†s 11:00)
 */
function enviarResumoConsolidado() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getDataRange().getValues();
  var confirmados = data.filter(function(row, index) { return index > 0 && row[1] === 'Sim'; });
  if (confirmados.length === 0) return;

  var totalPessoas = confirmados.reduce(function(acc, row) { return acc + 1 + parseInt(row[2] || 0); }, 0);

  var htmlBody = "<div style='font-family: sans-serif; color: #444; max-width: 600px; margin: auto; border: 1px solid #eee; padding: 25px; border-radius: 20px;'>";
  htmlBody += "<h2 style='color: #8e44ad; text-align: center;'>üìä Relat√≥rio de Confirmados: Sofia 5 Anos</h2>";
  htmlBody += "<table style='width: 100%; background: #f9f4ff; border-radius: 15px; margin-bottom: 25px;'><tr><td style='text-align: center; padding: 20px;'><b>Convites:</b><br>" + confirmados.length + "</td><td style='text-align: center; padding: 20px;'><b>Total Pessoas:</b><br>" + totalPessoas + "</td></tr></table>";
  htmlBody += "<table style='width: 100%; border-collapse: collapse;'><thead><tr style='color: #8e44ad; border-bottom: 2px solid #eee;'><th align='left' style='padding: 10px;'>CONVIDADO</th><th align='right' style='padding: 10px;'>ACOMP.</th></tr></thead><tbody>";
  confirmados.forEach(function(convidado) { htmlBody += "<tr style='border-bottom: 1px solid #f9f9f9;'><td style='padding: 12px 10px;'>" + convidado[0] + "</td><td align='right' style='padding: 12px 10px; color: #777;'>+" + convidado[2] + "</td></tr>"; });
  htmlBody += "</tbody></table><div style='text-align: center; margin-top: 30px;'><a href='https://sofiafaz5.vercel.app/lista.html' style='background-color: #8e44ad; color: white; padding: 15px 25px; text-decoration: none; border-radius: 12px; font-weight: bold;'>Ver Painel Completo</a></div></div>";

  MailApp.sendEmail({ to: "tacito1.filho@gmail.com, ursula.bastos78@gmail.com", subject: "üìä Resumo Atualizado: " + confirmados.length + " Convites", htmlBody: htmlBody, name: "Sistema Sofia üéÇ" });
}

/**
 * Retorna dados para a p√°gina lista.html
 */
function doGet() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getDataRange().getValues();
  var result = data.slice(1).map(function(row) {
    return { nome: row[0], presenca: row[1], acompanhantes: row[2], id: row[3], email: row[4], lembrete: row[5] === true || row[5] === "TRUE" };
  });
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * LEMBRETE DE 1 SEMANA (Gatilho: Data Espec√≠fica 10/07/2026)
 */
function enviarLembreteUmaSemana() {
  gerarEEnviarEmailLembrete("Falta apenas 1 semana! üéÇ", "O grande dia est√° chegando e mal podemos esperar para comemorar com voc√™!");
}

/**
 * NOVO: LEMBRETE DE V√âSPERA (Gatilho: Data Espec√≠fica 16/07/2026)
 */
function enviarLembreteAmanha() {
  gerarEEnviarEmailLembrete("√â amanh√£! ü•≥", "Cora√ß√£o a mil! Passando para lembrar que amanh√£ teremos a festa da Sofia. Prepare o sorriso e venha comemorar conosco!");
}

/**
 * FUN√á√ÉO AUXILIAR DE DISPARO DE LEMBRETES (Padronizada)
 */
function gerarEEnviarEmailLembrete(titulo, mensagemPersonalizada) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getDataRange().getValues();
  var corPrincipal = "#8e44ad";
  var corFundo = "#f9f4ff";

  for (var i = 1; i < data.length; i++) {
    var nome = data[i][0];
    var presenca = data[i][1];
    var emailConvidado = data[i][4];
    var querLembrete = data[i][5];

    if (presenca === "Sim" && emailConvidado && (querLembrete === true || querLembrete === "TRUE")) {
      var htmlBody = `
        <div style="font-family: sans-serif; color: #333; max-width: 600px; margin: auto; border: 1px solid #eee; border-radius: 20px; overflow: hidden;">
          <div style="background-color: ${corPrincipal}; padding: 30px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 24px;">${titulo}</h1>
          </div>
          <div style="padding: 30px; background-color: white; text-align: center;">
            <p style="font-size: 18px;">Ol√°, <strong>${nome}</strong>!</p>
            <p style="color: #666; line-height: 1.6;">${mensagemPersonalizada}</p>
            
            <div style="background-color: ${corFundo}; padding: 25px; border-radius: 15px; margin: 25px 0; border: 1px dashed ${corPrincipal}; text-align: left;">
                <p style="margin: 8px 0;">üìÖ <strong>Data:</strong> 17 de Julho de 2026</p>
                <p style="margin: 8px 0;">‚è∞ <strong>Hor√°rio:</strong> A partir das 19:00h</p>
                <p style="margin: 8px 0;">üìç <strong>Local:</strong> Fazendo a festa Kids</p>
                <p style="margin: 8px 0; font-size: 14px; color: #555;">R. Cel. An√≠zio Rodrigues Coelho, 275 - Boa Viagem, Recife - PE</p>
            </div>

            <p style="font-weight: bold; color: ${corPrincipal}; margin-bottom: 20px;">Como chegar:</p>
            
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td align="center">
                  <table border="0" cellspacing="0" cellpadding="0">
                    <tr>
                      <td align="center" style="padding: 10px;">
                        <a href="https://www.google.com/maps/search/?api=1&query=Fazendo+a+festa+Kids+Recife" target="_blank" 
                           style="background-color: #4285F4; color: #ffffff; padding: 12px 20px; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 14px; display: inline-block; min-width: 130px; text-align: center;">
                           Google Maps
                        </a>
                      </td>
                      <td align="center" style="padding: 10px;">
                        <a href="https://waze.com/ul?q=R.+Cel.+An√≠zio+Rodrigues+Coelho,+275+Boa+Viagem+Recife&navigate=yes" target="_blank" 
                           style="background-color: #33CCFF; color: #1e272e; padding: 12px 20px; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 14px; display: inline-block; min-width: 130px; text-align: center;">
                           Waze
                        </a>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
            <p style="color: #999; font-size: 11px; margin-top: 30px;">Lembrete enviado automaticamente pelo sistema de confirma√ß√£o da Sofia.</p>
          </div>
        </div>`;

      try {
        MailApp.sendEmail({
          to: emailConvidado,
          subject: titulo + " Anivers√°rio da Sofia",
          htmlBody: htmlBody,
          name: "Fam√≠lia da Sofia üéÇ"
        });
      } catch (e) { Logger.log("Erro ao enviar: " + e); }
    }
  }
}